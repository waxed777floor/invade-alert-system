<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="assets/img/apple-icon.png">
  <title>
    INVADE ALERT SYSTEM
  </title>
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <!-- Nucleo Icons -->
  <link href="assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <link href="assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- CSS Files -->
  <link id="pagestyle" href="assets/css/argon-dashboard.css?v=2.0.5" rel="stylesheet" />
</head>

<body class="g-sidenav-show   bg-gray-100">
  <div class="min-height-300 bg-primary position-absolute w-100"></div>
 
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg  px-0 mx-4 shadow-none border-radius-xl z-index-sticky " id="navbarBlur" data-scroll="false">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
            <li class="breadcrumb-item text-sm">
              <a class="text-white" href="javascript:;">
                <i class="ni ni-box-2"></i>
              </a>
            </li>
            <li class="breadcrumb-item text-sm text-white"><a class="opacity-5 text-white" href="javascript:;">管理頁面</a></li>
            <li class="breadcrumb-item text-sm text-white active" aria-current="page">入侵通知系統</li>
          </ol>
          <h6 class="font-weight-bolder mb-0 text-white">入侵通知系統</h6>
        </nav>
      </div>
    </nav>
    <!-- End Navbar -->
    <div class="container-fluid py-4">
      <div class="row mt-4">
        <div class="col-12">
          <div class="card shadow-lg">
            <img src="assets/img/shapes/pattern-left.png" alt="pattern-lines" class="position-absolute overflow-hidden opacity-4 start-0 top-0 h-100 border-radius-xl">
            <img src="assets/img/shapes/pattern-right.png" alt="pattern-lines" class="position-absolute overflow-hidden opacity-4 end-0 top-0 h-100 border-radius-xl">
            <div class="card-body px-5 z-index-1 bg-cover">
              <div class="row">
                <div class="col-lg-3 col-12 my-auto">
                  <h4 class="text-body opacity-9 text-center">入侵率</h4>
                  <hr class="horizontal light mt-1 mb-3">
                  <div class="d-flex justify-content-center">
                    <div>
                      <h3 class="text-body">2 <small class="text-sm align-top">%</small></h3>
                      <h6 class="mb-0 text-body opacity-7">  </h6>
                    </div>                   
                  </div>
                </div>
                <div class="col-lg-6 col-12 text-center">
                  <img class="w-75 w-lg-100 mt-n7 mt-lg-n8 d-none d-md-block" src="assets/img/PPP0.png" alt="car image">
                  <!-- <div class="d-flex align-items-center">
                    <h4 class="text-body opacity-7 ms-0 ms-md-auto">入侵率</h4>
                    <h2 class="text-body ms-2 me-auto">47<small class="text-sm align-top"> %</small></h2>
                  </div> -->
                </div>
                <div class="col-lg-3 col-12 my-auto">
                  <h4 class="text-body opacity-9">sketch_oct13a</h4>
                  <hr class="horizontal light mt-1 mb-3">
                  <div class="d-flex align-items-center">
                    <div>
                      <h6 class="mb-0 text-body">Arduino 1.8.18</h6>
                      <h6 class="mb-0 text-body">COM5</h6>
                    </div>
                    <div class="ms-lg-6 ms-4">
                      <button class="btn btn-icon-only btn-rounded btn-outline-dark mb-0 py-0">
                        <i class="ni ni-map-big" aria-hidden="true"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row mt-4">
        <div class="col-lg-3 col-md-6 col-12">
          <div id="card1" class="card bg-primary">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-white text-sm mb-0 text-uppercase font-weight-bold opacity-7">防區1</p>
                    <h5 id="card1Txt1" class="text-white font-weight-bolder mb-0">
                      目前系統異常
                    </h5>
                    <h5 id="card1Txt2" class="text-white font-weight-bolder mb-0">
                      訊號更新在 很久以前
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-white shadow text-center rounded-circle">
                    <i class="ni ni-delivery-fast text-dark text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 col-12 mt-4 mt-md-0">
          <div id="card2" class="card bg-primary">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-white text-sm mb-0 text-uppercase font-weight-bold opacity-7">防區2</p>
                    <h5 id="card2Txt1" class="text-white font-weight-bolder mb-0">
                      目前系統異常
                    </h5>
                    <h5 id="card2Txt2" class="text-white font-weight-bolder mb-0">
                      訊號更新在 很久以前
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-white shadow text-center rounded-circle">
                    <i class="ni ni-delivery-fast text-dark text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 col-12 mt-4 mt-lg-0">
          <div id="card3" class="card bg-primary">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-white text-sm mb-0 text-uppercase font-weight-bold opacity-7">防區3</p>
                    <h5 id="card3Txt1" class="text-white font-weight-bolder mb-0">
                      目前系統異常
                    </h5>
                    <h5 id="card3Txt2" class="text-white font-weight-bolder mb-0">
                      訊號更新在 很久以前
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-white shadow text-center rounded-circle">
                    <i class="ni ni-delivery-fast text-dark text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 col-12 mt-4 mt-lg-0">
          <div id="card4" class="card bg-danger">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-8">
                  <div class="numbers">
                    <p class="text-white text-sm mb-0 text-uppercase font-weight-bold opacity-7">防區4</p>
                    <h5 id="card4Txt1" class="text-white font-weight-bolder mb-0">
                      目前系統異常
                    </h5>
                    <h5 id="card4Txt2" class="text-white font-weight-bolder mb-0">
                      訊號更新在 很久以前
                    </h5>
                  </div>
                </div>
                <div class="col-4 text-end">
                  <div class="icon icon-shape bg-white shadow text-center rounded-circle">
                    <i class="ni ni-delivery-fast text-dark text-lg opacity-10" aria-hidden="true"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  
 
  <!--   Core JS Files   -->
  <script src="assets/js/core/popper.min.js"></script>
  <script src="assets/js/core/bootstrap.min.js"></script>
  <script src="assets/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="assets/js/plugins/smooth-scrollbar.min.js"></script>
  <!-- Kanban scripts -->
  <script src="assets/js/plugins/dragula/dragula.min.js"></script>
  <script src="assets/js/plugins/jkanban/jkanban.js"></script>
  <script src="assets/js/plugins/nouislider.min.js"></script>
  <script src="assets/js/plugins/sweetalert.min.js"></script>
  <script>
    // 捲動到網頁底部
    function scrollToBottom() {
      window.scrollTo(0, document.body.scrollHeight);
    }

    // 呼叫函式以執行捲動到底部和禁止水平捲動
    scrollToBottom();
    window.onload = function() {
        doWork();
    }

    const params = [1, 2, 3, 4];
    setInterval(async () => {
      doWork();
    }, 10000);

    async function doWork() {
      for (const param of params) {
            const result = await getRequest(param);
            // console.log(result);
            //訊號更新在 很久以前

            const firstChar = result.result.Value[0];//  系統健康度 0為異常 1為正常
            const secondChar = result.result.Value[1];// 防區編號 1 2 3 4
            const thirdChar = result.result.Value[2];//  是否入侵 0為無入侵 其餘有入侵

            const CreateDate = result.result.CreateDate;
            // 獲取東八區的當下時間
            const currentDateTime = new Date();
            // console.log("CreateDate");
            // console.log(CreateDate);
            // console.log("currentDateTime");
            // console.log(currentDateTime);
            let timeDif = timeDifference(currentDateTime, CreateDate);
            // console.log(timeDif);

            changeCardColor(param, firstChar);
            changeTimeDif(param, timeDif);

             //pop alert
             if(thirdChar === '0'){

            }else{  
              // 將日期物件轉換為 'yyyy-MM-dd HH:mm:ss' 格式的字符串
              const year = CreateDate.getFullYear();
              const month = String(CreateDate.getMonth() + 1).padStart(2, '0');
              const day = String(CreateDate.getDate()).padStart(2, '0');
              const hours = String(CreateDate.getHours()).padStart(2, '0');
              const minutes = String(CreateDate.getMinutes()).padStart(2, '0');
              const seconds = String(CreateDate.getSeconds()).padStart(2, '0');
              let DTString = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;

              let alertTxt = `防區 ${parseInt(secondChar)} 有入侵 <br/><br/>
               ${DTString}`;
              showAlert(alertTxt);
            }              
        }
    }  

    function showAlert(t) {
      // let t = "防區3 入侵 " + "<br/>" + "2023/06/28 05:11:12";
      Swal.fire(t);
    }    

    async function getRequest(param) {
        const response = await fetch(`http://104.197.172.206/api/v1/invadeGet/${param}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        } else {
            const data = await response.json();

            // 創建日期物件
            let date = new Date(data.result.CreateDate);            
            // 減去8小時
            date.setHours(date.getHours() - 8);
            data.result.CreateDate = date;
            return data;
        }
    }

    function changeCardColor(num, firstChar) {
      const card = document.getElementById('card' + num);
      const cardTxt = document.getElementById('card' + num + 'Txt1');
      
      if (firstChar === '0') {
        card.className = 'card bg-danger';
        cardTxt.innerText = "系統異常";
      } else if (firstChar === '1') {
        card.className = 'card bg-primary';
        cardTxt.innerText = "系統正常";
      }
    }  

    function changeTimeDif(num, timeDif) {
      const cardTxt = document.getElementById('card' + num + 'Txt2');      
      cardTxt.innerText = "訊號更新: " + timeDif;     
    } 

    // 計算差異並轉換成合適的格式
    function timeDifference(current, previous) {
        const milliSecondDiff = current - previous;
        const secondDiff = Math.floor(milliSecondDiff / 1000);
        const minuteDiff = Math.floor(secondDiff / 60);
        const hourDiff = Math.floor(minuteDiff / 60);

        if (hourDiff > 0) return `${hourDiff} 小時前`;
        if (minuteDiff > 0) return `${minuteDiff} 分鐘前`;
        return `${secondDiff} 秒前`;
    }


  </script>
  <script src="assets/js/argon-dashboard.min.js?v=2.0.5"></script>
</body>
</html>